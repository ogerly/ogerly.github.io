import{TrianglesDrawMode as Le,TriangleFanDrawMode as Y,TriangleStripDrawMode as he,Loader as we,LoaderUtils as W,FileLoader as de,MeshPhysicalMaterial as I,Vector2 as fe,Color as O,LinearSRGBColorSpace as M,SRGBColorSpace as G,SpotLight as Ne,PointLight as Se,DirectionalLight as _e,Matrix4 as U,Vector3 as P,InstancedMesh as be,Quaternion as pe,Object3D as J,TextureLoader as Me,ImageBitmapLoader as Ie,BufferAttribute as j,InterleavedBuffer as Ce,LinearMipmapLinearFilter as me,NearestMipmapLinearFilter as Oe,LinearMipmapNearestFilter as ve,NearestMipmapNearestFilter as Pe,LinearFilter as Ae,NearestFilter as Fe,RepeatWrapping as Q,MirroredRepeatWrapping as De,ClampToEdgeWrapping as ke,PointsMaterial as He,Material as K,LineBasicMaterial as Ge,MeshStandardMaterial as ge,DoubleSide as Ue,MeshBasicMaterial as F,PropertyBinding as Be,BufferGeometry as je,SkinnedMesh as Ke,Mesh as Te,LineSegments as Ve,Line as Xe,LineLoop as ze,Points as qe,Group as V,PerspectiveCamera as Ye,MathUtils as We,OrthographicCamera as Qe,Skeleton as $e,AnimationClip as Ze,Bone as Je,InterpolateDiscrete as et,InterpolateLinear as xe,InterleavedBufferAttribute as tt,Texture as ee,VectorKeyframeTrack as te,NumberKeyframeTrack as ne,QuaternionKeyframeTrack as se,ColorManagement as ie,FrontSide as nt,Interpolant as st,Box3 as it,Sphere as rt,SphereGeometry as ot}from"./three.module-Dz-eZr9z.js";function re(h,t){if(t===Le)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),h;if(t===Y||t===he){let e=h.getIndex();if(e===null){const s=[],a=h.getAttribute("position");if(a!==void 0){for(let o=0;o<a.count;o++)s.push(o);h.setIndex(s),e=h.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),h}const r=e.count-2,n=[];if(t===Y)for(let s=1;s<=r;s++)n.push(e.getX(0)),n.push(e.getX(s)),n.push(e.getX(s+1));else for(let s=0;s<r;s++)s%2===0?(n.push(e.getX(s)),n.push(e.getX(s+1)),n.push(e.getX(s+2))):(n.push(e.getX(s+2)),n.push(e.getX(s+1)),n.push(e.getX(s)));n.length/3!==r&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const i=h.clone();return i.setIndex(n),i.clearGroups(),i}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),h}class at extends we{constructor(t){super(t),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(e){return new dt(e)}),this.register(function(e){return new Et(e)}),this.register(function(e){return new Rt(e)}),this.register(function(e){return new yt(e)}),this.register(function(e){return new pt(e)}),this.register(function(e){return new mt(e)}),this.register(function(e){return new At(e)}),this.register(function(e){return new gt(e)}),this.register(function(e){return new ht(e)}),this.register(function(e){return new Tt(e)}),this.register(function(e){return new ft(e)}),this.register(function(e){return new xt(e)}),this.register(function(e){return new ut(e)}),this.register(function(e){return new Lt(e)}),this.register(function(e){return new wt(e)})}load(t,e,r,n){const i=this;let s;this.resourcePath!==""?s=this.resourcePath:this.path!==""?s=this.path:s=W.extractUrlBase(t),this.manager.itemStart(t);const a=function(c){n?n(c):console.error(c),i.manager.itemError(t),i.manager.itemEnd(t)},o=new de(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(t,function(c){try{i.parse(c,s,function(l){e(l),i.manager.itemEnd(t)},a)}catch(l){a(l)}},r,a)}setDRACOLoader(t){return this.dracoLoader=t,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(t){return this.ktx2Loader=t,this}setMeshoptDecoder(t){return this.meshoptDecoder=t,this}register(t){return this.pluginCallbacks.indexOf(t)===-1&&this.pluginCallbacks.push(t),this}unregister(t){return this.pluginCallbacks.indexOf(t)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(t),1),this}parse(t,e,r,n){let i;const s={},a={},o=new TextDecoder;if(typeof t=="string")i=JSON.parse(t);else if(t instanceof ArrayBuffer)if(o.decode(new Uint8Array(t,0,4))===Ee){try{s[A.KHR_BINARY_GLTF]=new Nt(t)}catch(u){n&&n(u);return}i=JSON.parse(s[A.KHR_BINARY_GLTF].content)}else i=JSON.parse(o.decode(t));else i=t;if(i.asset===void 0||i.asset.version[0]<2){n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const c=new Ht(i,{path:e||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});c.fileLoader.setRequestHeader(this.requestHeader);for(let l=0;l<this.pluginCallbacks.length;l++){const u=this.pluginCallbacks[l](c);a[u.name]=u,s[u.name]=!0}if(i.extensionsUsed)for(let l=0;l<i.extensionsUsed.length;++l){const u=i.extensionsUsed[l],d=i.extensionsRequired||[];switch(u){case A.KHR_MATERIALS_UNLIT:s[u]=new lt;break;case A.KHR_DRACO_MESH_COMPRESSION:s[u]=new St(i,this.dracoLoader);break;case A.KHR_TEXTURE_TRANSFORM:s[u]=new _t;break;case A.KHR_MESH_QUANTIZATION:s[u]=new bt;break;default:d.indexOf(u)>=0&&a[u]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+u+'".')}}c.setExtensions(s),c.setPlugins(a),c.parse(r,n)}parseAsync(t,e){const r=this;return new Promise(function(n,i){r.parse(t,e,n,i)})}}function ct(){let h={};return{get:function(t){return h[t]},add:function(t,e){h[t]=e},remove:function(t){delete h[t]},removeAll:function(){h={}}}}const A={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class ut{constructor(t){this.parser=t,this.name=A.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const t=this.parser,e=this.parser.json.nodes||[];for(let r=0,n=e.length;r<n;r++){const i=e[r];i.extensions&&i.extensions[this.name]&&i.extensions[this.name].light!==void 0&&t._addNodeRef(this.cache,i.extensions[this.name].light)}}_loadLight(t){const e=this.parser,r="light:"+t;let n=e.cache.get(r);if(n)return n;const i=e.json,o=((i.extensions&&i.extensions[this.name]||{}).lights||[])[t];let c;const l=new O(16777215);o.color!==void 0&&l.setRGB(o.color[0],o.color[1],o.color[2],M);const u=o.range!==void 0?o.range:0;switch(o.type){case"directional":c=new _e(l),c.target.position.set(0,0,-1),c.add(c.target);break;case"point":c=new Se(l),c.distance=u;break;case"spot":c=new Ne(l),c.distance=u,o.spot=o.spot||{},o.spot.innerConeAngle=o.spot.innerConeAngle!==void 0?o.spot.innerConeAngle:0,o.spot.outerConeAngle=o.spot.outerConeAngle!==void 0?o.spot.outerConeAngle:Math.PI/4,c.angle=o.spot.outerConeAngle,c.penumbra=1-o.spot.innerConeAngle/o.spot.outerConeAngle,c.target.position.set(0,0,-1),c.add(c.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+o.type)}return c.position.set(0,0,0),c.decay=2,b(c,o),o.intensity!==void 0&&(c.intensity=o.intensity),c.name=e.createUniqueName(o.name||"light_"+t),n=Promise.resolve(c),e.cache.add(r,n),n}getDependency(t,e){if(t==="light")return this._loadLight(e)}createNodeAttachment(t){const e=this,r=this.parser,i=r.json.nodes[t],a=(i.extensions&&i.extensions[this.name]||{}).light;return a===void 0?null:this._loadLight(a).then(function(o){return r._getNodeRef(e.cache,a,o)})}}class lt{constructor(){this.name=A.KHR_MATERIALS_UNLIT}getMaterialType(){return F}extendParams(t,e,r){const n=[];t.color=new O(1,1,1),t.opacity=1;const i=e.pbrMetallicRoughness;if(i){if(Array.isArray(i.baseColorFactor)){const s=i.baseColorFactor;t.color.setRGB(s[0],s[1],s[2],M),t.opacity=s[3]}i.baseColorTexture!==void 0&&n.push(r.assignTexture(t,"map",i.baseColorTexture,G))}return Promise.all(n)}}class ht{constructor(t){this.parser=t,this.name=A.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(t,e){const n=this.parser.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=n.extensions[this.name].emissiveStrength;return i!==void 0&&(e.emissiveIntensity=i),Promise.resolve()}}class dt{constructor(t){this.parser=t,this.name=A.KHR_MATERIALS_CLEARCOAT}getMaterialType(t){const r=this.parser.json.materials[t];return!r.extensions||!r.extensions[this.name]?null:I}extendMaterialParams(t,e){const r=this.parser,n=r.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],s=n.extensions[this.name];if(s.clearcoatFactor!==void 0&&(e.clearcoat=s.clearcoatFactor),s.clearcoatTexture!==void 0&&i.push(r.assignTexture(e,"clearcoatMap",s.clearcoatTexture)),s.clearcoatRoughnessFactor!==void 0&&(e.clearcoatRoughness=s.clearcoatRoughnessFactor),s.clearcoatRoughnessTexture!==void 0&&i.push(r.assignTexture(e,"clearcoatRoughnessMap",s.clearcoatRoughnessTexture)),s.clearcoatNormalTexture!==void 0&&(i.push(r.assignTexture(e,"clearcoatNormalMap",s.clearcoatNormalTexture)),s.clearcoatNormalTexture.scale!==void 0)){const a=s.clearcoatNormalTexture.scale;e.clearcoatNormalScale=new fe(a,a)}return Promise.all(i)}}class ft{constructor(t){this.parser=t,this.name=A.KHR_MATERIALS_IRIDESCENCE}getMaterialType(t){const r=this.parser.json.materials[t];return!r.extensions||!r.extensions[this.name]?null:I}extendMaterialParams(t,e){const r=this.parser,n=r.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],s=n.extensions[this.name];return s.iridescenceFactor!==void 0&&(e.iridescence=s.iridescenceFactor),s.iridescenceTexture!==void 0&&i.push(r.assignTexture(e,"iridescenceMap",s.iridescenceTexture)),s.iridescenceIor!==void 0&&(e.iridescenceIOR=s.iridescenceIor),e.iridescenceThicknessRange===void 0&&(e.iridescenceThicknessRange=[100,400]),s.iridescenceThicknessMinimum!==void 0&&(e.iridescenceThicknessRange[0]=s.iridescenceThicknessMinimum),s.iridescenceThicknessMaximum!==void 0&&(e.iridescenceThicknessRange[1]=s.iridescenceThicknessMaximum),s.iridescenceThicknessTexture!==void 0&&i.push(r.assignTexture(e,"iridescenceThicknessMap",s.iridescenceThicknessTexture)),Promise.all(i)}}class pt{constructor(t){this.parser=t,this.name=A.KHR_MATERIALS_SHEEN}getMaterialType(t){const r=this.parser.json.materials[t];return!r.extensions||!r.extensions[this.name]?null:I}extendMaterialParams(t,e){const r=this.parser,n=r.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[];e.sheenColor=new O(0,0,0),e.sheenRoughness=0,e.sheen=1;const s=n.extensions[this.name];if(s.sheenColorFactor!==void 0){const a=s.sheenColorFactor;e.sheenColor.setRGB(a[0],a[1],a[2],M)}return s.sheenRoughnessFactor!==void 0&&(e.sheenRoughness=s.sheenRoughnessFactor),s.sheenColorTexture!==void 0&&i.push(r.assignTexture(e,"sheenColorMap",s.sheenColorTexture,G)),s.sheenRoughnessTexture!==void 0&&i.push(r.assignTexture(e,"sheenRoughnessMap",s.sheenRoughnessTexture)),Promise.all(i)}}class mt{constructor(t){this.parser=t,this.name=A.KHR_MATERIALS_TRANSMISSION}getMaterialType(t){const r=this.parser.json.materials[t];return!r.extensions||!r.extensions[this.name]?null:I}extendMaterialParams(t,e){const r=this.parser,n=r.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],s=n.extensions[this.name];return s.transmissionFactor!==void 0&&(e.transmission=s.transmissionFactor),s.transmissionTexture!==void 0&&i.push(r.assignTexture(e,"transmissionMap",s.transmissionTexture)),Promise.all(i)}}class At{constructor(t){this.parser=t,this.name=A.KHR_MATERIALS_VOLUME}getMaterialType(t){const r=this.parser.json.materials[t];return!r.extensions||!r.extensions[this.name]?null:I}extendMaterialParams(t,e){const r=this.parser,n=r.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],s=n.extensions[this.name];e.thickness=s.thicknessFactor!==void 0?s.thicknessFactor:0,s.thicknessTexture!==void 0&&i.push(r.assignTexture(e,"thicknessMap",s.thicknessTexture)),e.attenuationDistance=s.attenuationDistance||1/0;const a=s.attenuationColor||[1,1,1];return e.attenuationColor=new O().setRGB(a[0],a[1],a[2],M),Promise.all(i)}}class gt{constructor(t){this.parser=t,this.name=A.KHR_MATERIALS_IOR}getMaterialType(t){const r=this.parser.json.materials[t];return!r.extensions||!r.extensions[this.name]?null:I}extendMaterialParams(t,e){const n=this.parser.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=n.extensions[this.name];return e.ior=i.ior!==void 0?i.ior:1.5,Promise.resolve()}}class Tt{constructor(t){this.parser=t,this.name=A.KHR_MATERIALS_SPECULAR}getMaterialType(t){const r=this.parser.json.materials[t];return!r.extensions||!r.extensions[this.name]?null:I}extendMaterialParams(t,e){const r=this.parser,n=r.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],s=n.extensions[this.name];e.specularIntensity=s.specularFactor!==void 0?s.specularFactor:1,s.specularTexture!==void 0&&i.push(r.assignTexture(e,"specularIntensityMap",s.specularTexture));const a=s.specularColorFactor||[1,1,1];return e.specularColor=new O().setRGB(a[0],a[1],a[2],M),s.specularColorTexture!==void 0&&i.push(r.assignTexture(e,"specularColorMap",s.specularColorTexture,G)),Promise.all(i)}}class xt{constructor(t){this.parser=t,this.name=A.KHR_MATERIALS_ANISOTROPY}getMaterialType(t){const r=this.parser.json.materials[t];return!r.extensions||!r.extensions[this.name]?null:I}extendMaterialParams(t,e){const r=this.parser,n=r.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],s=n.extensions[this.name];return s.anisotropyStrength!==void 0&&(e.anisotropy=s.anisotropyStrength),s.anisotropyRotation!==void 0&&(e.anisotropyRotation=s.anisotropyRotation),s.anisotropyTexture!==void 0&&i.push(r.assignTexture(e,"anisotropyMap",s.anisotropyTexture)),Promise.all(i)}}class Et{constructor(t){this.parser=t,this.name=A.KHR_TEXTURE_BASISU}loadTexture(t){const e=this.parser,r=e.json,n=r.textures[t];if(!n.extensions||!n.extensions[this.name])return null;const i=n.extensions[this.name],s=e.options.ktx2Loader;if(!s){if(r.extensionsRequired&&r.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return e.loadTextureImage(t,i.source,s)}}class Rt{constructor(t){this.parser=t,this.name=A.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(t){const e=this.name,r=this.parser,n=r.json,i=n.textures[t];if(!i.extensions||!i.extensions[e])return null;const s=i.extensions[e],a=n.images[s.source];let o=r.textureLoader;if(a.uri){const c=r.options.manager.getHandler(a.uri);c!==null&&(o=c)}return this.detectSupport().then(function(c){if(c)return r.loadTextureImage(t,s.source,o);if(n.extensionsRequired&&n.extensionsRequired.indexOf(e)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return r.loadTexture(t)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(t){const e=new Image;e.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",e.onload=e.onerror=function(){t(e.height===1)}})),this.isSupported}}class yt{constructor(t){this.parser=t,this.name=A.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(t){const e=this.name,r=this.parser,n=r.json,i=n.textures[t];if(!i.extensions||!i.extensions[e])return null;const s=i.extensions[e],a=n.images[s.source];let o=r.textureLoader;if(a.uri){const c=r.options.manager.getHandler(a.uri);c!==null&&(o=c)}return this.detectSupport().then(function(c){if(c)return r.loadTextureImage(t,s.source,o);if(n.extensionsRequired&&n.extensionsRequired.indexOf(e)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return r.loadTexture(t)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(t){const e=new Image;e.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",e.onload=e.onerror=function(){t(e.height===1)}})),this.isSupported}}class Lt{constructor(t){this.name=A.EXT_MESHOPT_COMPRESSION,this.parser=t}loadBufferView(t){const e=this.parser.json,r=e.bufferViews[t];if(r.extensions&&r.extensions[this.name]){const n=r.extensions[this.name],i=this.parser.getDependency("buffer",n.buffer),s=this.parser.options.meshoptDecoder;if(!s||!s.supported){if(e.extensionsRequired&&e.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return i.then(function(a){const o=n.byteOffset||0,c=n.byteLength||0,l=n.count,u=n.byteStride,d=new Uint8Array(a,o,c);return s.decodeGltfBufferAsync?s.decodeGltfBufferAsync(l,u,d,n.mode,n.filter).then(function(f){return f.buffer}):s.ready.then(function(){const f=new ArrayBuffer(l*u);return s.decodeGltfBuffer(new Uint8Array(f),l,u,d,n.mode,n.filter),f})})}else return null}}class wt{constructor(t){this.name=A.EXT_MESH_GPU_INSTANCING,this.parser=t}createNodeMesh(t){const e=this.parser.json,r=e.nodes[t];if(!r.extensions||!r.extensions[this.name]||r.mesh===void 0)return null;const n=e.meshes[r.mesh];for(const c of n.primitives)if(c.mode!==L.TRIANGLES&&c.mode!==L.TRIANGLE_STRIP&&c.mode!==L.TRIANGLE_FAN&&c.mode!==void 0)return null;const s=r.extensions[this.name].attributes,a=[],o={};for(const c in s)a.push(this.parser.getDependency("accessor",s[c]).then(l=>(o[c]=l,o[c])));return a.length<1?null:(a.push(this.parser.createNodeMesh(t)),Promise.all(a).then(c=>{const l=c.pop(),u=l.isGroup?l.children:[l],d=c[0].count,f=[];for(const p of u){const T=new U,m=new P,g=new pe,E=new P(1,1,1),y=new be(p.geometry,p.material,d);for(let x=0;x<d;x++)o.TRANSLATION&&m.fromBufferAttribute(o.TRANSLATION,x),o.ROTATION&&g.fromBufferAttribute(o.ROTATION,x),o.SCALE&&E.fromBufferAttribute(o.SCALE,x),y.setMatrixAt(x,T.compose(m,g,E));for(const x in o)x!=="TRANSLATION"&&x!=="ROTATION"&&x!=="SCALE"&&p.geometry.setAttribute(x,o[x]);J.prototype.copy.call(y,p),this.parser.assignFinalMaterial(y),f.push(y)}return l.isGroup?(l.clear(),l.add(...f),l):f[0]}))}}const Ee="glTF",H=12,oe={JSON:1313821514,BIN:5130562};class Nt{constructor(t){this.name=A.KHR_BINARY_GLTF,this.content=null,this.body=null;const e=new DataView(t,0,H),r=new TextDecoder;if(this.header={magic:r.decode(new Uint8Array(t.slice(0,4))),version:e.getUint32(4,!0),length:e.getUint32(8,!0)},this.header.magic!==Ee)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const n=this.header.length-H,i=new DataView(t,H);let s=0;for(;s<n;){const a=i.getUint32(s,!0);s+=4;const o=i.getUint32(s,!0);if(s+=4,o===oe.JSON){const c=new Uint8Array(t,H+s,a);this.content=r.decode(c)}else if(o===oe.BIN){const c=H+s;this.body=t.slice(c,c+a)}s+=a}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class St{constructor(t,e){if(!e)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=A.KHR_DRACO_MESH_COMPRESSION,this.json=t,this.dracoLoader=e,this.dracoLoader.preload()}decodePrimitive(t,e){const r=this.json,n=this.dracoLoader,i=t.extensions[this.name].bufferView,s=t.extensions[this.name].attributes,a={},o={},c={};for(const l in s){const u=$[l]||l.toLowerCase();a[u]=s[l]}for(const l in t.attributes){const u=$[l]||l.toLowerCase();if(s[l]!==void 0){const d=r.accessors[t.attributes[l]],f=D[d.componentType];c[u]=f.name,o[u]=d.normalized===!0}}return e.getDependency("bufferView",i).then(function(l){return new Promise(function(u){n.decodeDracoFile(l,function(d){for(const f in d.attributes){const p=d.attributes[f],T=o[f];T!==void 0&&(p.normalized=T)}u(d)},a,c)})})}}class _t{constructor(){this.name=A.KHR_TEXTURE_TRANSFORM}extendTexture(t,e){return(e.texCoord===void 0||e.texCoord===t.channel)&&e.offset===void 0&&e.rotation===void 0&&e.scale===void 0||(t=t.clone(),e.texCoord!==void 0&&(t.channel=e.texCoord),e.offset!==void 0&&t.offset.fromArray(e.offset),e.rotation!==void 0&&(t.rotation=e.rotation),e.scale!==void 0&&t.repeat.fromArray(e.scale),t.needsUpdate=!0),t}}class bt{constructor(){this.name=A.KHR_MESH_QUANTIZATION}}class Re extends st{constructor(t,e,r,n){super(t,e,r,n)}copySampleValue_(t){const e=this.resultBuffer,r=this.sampleValues,n=this.valueSize,i=t*n*3+n;for(let s=0;s!==n;s++)e[s]=r[i+s];return e}interpolate_(t,e,r,n){const i=this.resultBuffer,s=this.sampleValues,a=this.valueSize,o=a*2,c=a*3,l=n-e,u=(r-e)/l,d=u*u,f=d*u,p=t*c,T=p-c,m=-2*f+3*d,g=f-d,E=1-m,y=g-d+u;for(let x=0;x!==a;x++){const v=s[T+x+a],N=s[T+x+o]*l,w=s[p+x+a],k=s[p+x]*l;i[x]=E*v+y*N+m*w+g*k}return i}}const Mt=new pe;class It extends Re{interpolate_(t,e,r,n){const i=super.interpolate_(t,e,r,n);return Mt.fromArray(i).normalize().toArray(i),i}}const L={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},D={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},ae={9728:Fe,9729:Ae,9984:Pe,9985:ve,9986:Oe,9987:me},ce={33071:ke,33648:De,10497:Q},X={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},$={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},_={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Ct={CUBICSPLINE:void 0,LINEAR:xe,STEP:et},z={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function Ot(h){return h.DefaultMaterial===void 0&&(h.DefaultMaterial=new ge({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:nt})),h.DefaultMaterial}function C(h,t,e){for(const r in e.extensions)h[r]===void 0&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[r]=e.extensions[r])}function b(h,t){t.extras!==void 0&&(typeof t.extras=="object"?Object.assign(h.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function vt(h,t,e){let r=!1,n=!1,i=!1;for(let c=0,l=t.length;c<l;c++){const u=t[c];if(u.POSITION!==void 0&&(r=!0),u.NORMAL!==void 0&&(n=!0),u.COLOR_0!==void 0&&(i=!0),r&&n&&i)break}if(!r&&!n&&!i)return Promise.resolve(h);const s=[],a=[],o=[];for(let c=0,l=t.length;c<l;c++){const u=t[c];if(r){const d=u.POSITION!==void 0?e.getDependency("accessor",u.POSITION):h.attributes.position;s.push(d)}if(n){const d=u.NORMAL!==void 0?e.getDependency("accessor",u.NORMAL):h.attributes.normal;a.push(d)}if(i){const d=u.COLOR_0!==void 0?e.getDependency("accessor",u.COLOR_0):h.attributes.color;o.push(d)}}return Promise.all([Promise.all(s),Promise.all(a),Promise.all(o)]).then(function(c){const l=c[0],u=c[1],d=c[2];return r&&(h.morphAttributes.position=l),n&&(h.morphAttributes.normal=u),i&&(h.morphAttributes.color=d),h.morphTargetsRelative=!0,h})}function Pt(h,t){if(h.updateMorphTargets(),t.weights!==void 0)for(let e=0,r=t.weights.length;e<r;e++)h.morphTargetInfluences[e]=t.weights[e];if(t.extras&&Array.isArray(t.extras.targetNames)){const e=t.extras.targetNames;if(h.morphTargetInfluences.length===e.length){h.morphTargetDictionary={};for(let r=0,n=e.length;r<n;r++)h.morphTargetDictionary[e[r]]=r}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function Ft(h){let t;const e=h.extensions&&h.extensions[A.KHR_DRACO_MESH_COMPRESSION];if(e?t="draco:"+e.bufferView+":"+e.indices+":"+q(e.attributes):t=h.indices+":"+q(h.attributes)+":"+h.mode,h.targets!==void 0)for(let r=0,n=h.targets.length;r<n;r++)t+=":"+q(h.targets[r]);return t}function q(h){let t="";const e=Object.keys(h).sort();for(let r=0,n=e.length;r<n;r++)t+=e[r]+":"+h[e[r]]+";";return t}function Z(h){switch(h){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function Dt(h){return h.search(/\.jpe?g($|\?)/i)>0||h.search(/^data\:image\/jpeg/)===0?"image/jpeg":h.search(/\.webp($|\?)/i)>0||h.search(/^data\:image\/webp/)===0?"image/webp":"image/png"}const kt=new U;class Ht{constructor(t={},e={}){this.json=t,this.extensions={},this.plugins={},this.options=e,this.cache=new ct,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let r=!1,n=!1,i=-1;typeof navigator<"u"&&(r=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)===!0,n=navigator.userAgent.indexOf("Firefox")>-1,i=n?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),typeof createImageBitmap>"u"||r||n&&i<98?this.textureLoader=new Me(this.options.manager):this.textureLoader=new Ie(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new de(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(t){this.extensions=t}setPlugins(t){this.plugins=t}parse(t,e){const r=this,n=this.json,i=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(s){return s._markDefs&&s._markDefs()}),Promise.all(this._invokeAll(function(s){return s.beforeRoot&&s.beforeRoot()})).then(function(){return Promise.all([r.getDependencies("scene"),r.getDependencies("animation"),r.getDependencies("camera")])}).then(function(s){const a={scene:s[0][n.scene||0],scenes:s[0],animations:s[1],cameras:s[2],asset:n.asset,parser:r,userData:{}};C(i,a,n),b(a,n),Promise.all(r._invokeAll(function(o){return o.afterRoot&&o.afterRoot(a)})).then(function(){t(a)})}).catch(e)}_markDefs(){const t=this.json.nodes||[],e=this.json.skins||[],r=this.json.meshes||[];for(let n=0,i=e.length;n<i;n++){const s=e[n].joints;for(let a=0,o=s.length;a<o;a++)t[s[a]].isBone=!0}for(let n=0,i=t.length;n<i;n++){const s=t[n];s.mesh!==void 0&&(this._addNodeRef(this.meshCache,s.mesh),s.skin!==void 0&&(r[s.mesh].isSkinnedMesh=!0)),s.camera!==void 0&&this._addNodeRef(this.cameraCache,s.camera)}}_addNodeRef(t,e){e!==void 0&&(t.refs[e]===void 0&&(t.refs[e]=t.uses[e]=0),t.refs[e]++)}_getNodeRef(t,e,r){if(t.refs[e]<=1)return r;const n=r.clone(),i=(s,a)=>{const o=this.associations.get(s);o!=null&&this.associations.set(a,o);for(const[c,l]of s.children.entries())i(l,a.children[c])};return i(r,n),n.name+="_instance_"+t.uses[e]++,n}_invokeOne(t){const e=Object.values(this.plugins);e.push(this);for(let r=0;r<e.length;r++){const n=t(e[r]);if(n)return n}return null}_invokeAll(t){const e=Object.values(this.plugins);e.unshift(this);const r=[];for(let n=0;n<e.length;n++){const i=t(e[n]);i&&r.push(i)}return r}getDependency(t,e){const r=t+":"+e;let n=this.cache.get(r);if(!n){switch(t){case"scene":n=this.loadScene(e);break;case"node":n=this._invokeOne(function(i){return i.loadNode&&i.loadNode(e)});break;case"mesh":n=this._invokeOne(function(i){return i.loadMesh&&i.loadMesh(e)});break;case"accessor":n=this.loadAccessor(e);break;case"bufferView":n=this._invokeOne(function(i){return i.loadBufferView&&i.loadBufferView(e)});break;case"buffer":n=this.loadBuffer(e);break;case"material":n=this._invokeOne(function(i){return i.loadMaterial&&i.loadMaterial(e)});break;case"texture":n=this._invokeOne(function(i){return i.loadTexture&&i.loadTexture(e)});break;case"skin":n=this.loadSkin(e);break;case"animation":n=this._invokeOne(function(i){return i.loadAnimation&&i.loadAnimation(e)});break;case"camera":n=this.loadCamera(e);break;default:if(n=this._invokeOne(function(i){return i!=this&&i.getDependency&&i.getDependency(t,e)}),!n)throw new Error("Unknown type: "+t);break}this.cache.add(r,n)}return n}getDependencies(t){let e=this.cache.get(t);if(!e){const r=this,n=this.json[t+(t==="mesh"?"es":"s")]||[];e=Promise.all(n.map(function(i,s){return r.getDependency(t,s)})),this.cache.add(t,e)}return e}loadBuffer(t){const e=this.json.buffers[t],r=this.fileLoader;if(e.type&&e.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+e.type+" buffer type is not supported.");if(e.uri===void 0&&t===0)return Promise.resolve(this.extensions[A.KHR_BINARY_GLTF].body);const n=this.options;return new Promise(function(i,s){r.load(W.resolveURL(e.uri,n.path),i,void 0,function(){s(new Error('THREE.GLTFLoader: Failed to load buffer "'+e.uri+'".'))})})}loadBufferView(t){const e=this.json.bufferViews[t];return this.getDependency("buffer",e.buffer).then(function(r){const n=e.byteLength||0,i=e.byteOffset||0;return r.slice(i,i+n)})}loadAccessor(t){const e=this,r=this.json,n=this.json.accessors[t];if(n.bufferView===void 0&&n.sparse===void 0){const s=X[n.type],a=D[n.componentType],o=n.normalized===!0,c=new a(n.count*s);return Promise.resolve(new j(c,s,o))}const i=[];return n.bufferView!==void 0?i.push(this.getDependency("bufferView",n.bufferView)):i.push(null),n.sparse!==void 0&&(i.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),i.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(i).then(function(s){const a=s[0],o=X[n.type],c=D[n.componentType],l=c.BYTES_PER_ELEMENT,u=l*o,d=n.byteOffset||0,f=n.bufferView!==void 0?r.bufferViews[n.bufferView].byteStride:void 0,p=n.normalized===!0;let T,m;if(f&&f!==u){const g=Math.floor(d/f),E="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+g+":"+n.count;let y=e.cache.get(E);y||(T=new c(a,g*f,n.count*f/l),y=new Ce(T,f/l),e.cache.add(E,y)),m=new tt(y,o,d%f/l,p)}else a===null?T=new c(n.count*o):T=new c(a,d,n.count*o),m=new j(T,o,p);if(n.sparse!==void 0){const g=X.SCALAR,E=D[n.sparse.indices.componentType],y=n.sparse.indices.byteOffset||0,x=n.sparse.values.byteOffset||0,v=new E(s[1],y,n.sparse.count*g),N=new c(s[2],x,n.sparse.count*o);a!==null&&(m=new j(m.array.slice(),m.itemSize,m.normalized));for(let w=0,k=v.length;w<k;w++){const S=v[w];if(m.setX(S,N[w*o]),o>=2&&m.setY(S,N[w*o+1]),o>=3&&m.setZ(S,N[w*o+2]),o>=4&&m.setW(S,N[w*o+3]),o>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return m})}loadTexture(t){const e=this.json,r=this.options,i=e.textures[t].source,s=e.images[i];let a=this.textureLoader;if(s.uri){const o=r.manager.getHandler(s.uri);o!==null&&(a=o)}return this.loadTextureImage(t,i,a)}loadTextureImage(t,e,r){const n=this,i=this.json,s=i.textures[t],a=i.images[e],o=(a.uri||a.bufferView)+":"+s.sampler;if(this.textureCache[o])return this.textureCache[o];const c=this.loadImageSource(e,r).then(function(l){l.flipY=!1,l.name=s.name||a.name||"",l.name===""&&typeof a.uri=="string"&&a.uri.startsWith("data:image/")===!1&&(l.name=a.uri);const d=(i.samplers||{})[s.sampler]||{};return l.magFilter=ae[d.magFilter]||Ae,l.minFilter=ae[d.minFilter]||me,l.wrapS=ce[d.wrapS]||Q,l.wrapT=ce[d.wrapT]||Q,n.associations.set(l,{textures:t}),l}).catch(function(){return null});return this.textureCache[o]=c,c}loadImageSource(t,e){const r=this,n=this.json,i=this.options;if(this.sourceCache[t]!==void 0)return this.sourceCache[t].then(u=>u.clone());const s=n.images[t],a=self.URL||self.webkitURL;let o=s.uri||"",c=!1;if(s.bufferView!==void 0)o=r.getDependency("bufferView",s.bufferView).then(function(u){c=!0;const d=new Blob([u],{type:s.mimeType});return o=a.createObjectURL(d),o});else if(s.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+t+" is missing URI and bufferView");const l=Promise.resolve(o).then(function(u){return new Promise(function(d,f){let p=d;e.isImageBitmapLoader===!0&&(p=function(T){const m=new ee(T);m.needsUpdate=!0,d(m)}),e.load(W.resolveURL(u,i.path),p,void 0,f)})}).then(function(u){return c===!0&&a.revokeObjectURL(o),u.userData.mimeType=s.mimeType||Dt(s.uri),u}).catch(function(u){throw console.error("THREE.GLTFLoader: Couldn't load texture",o),u});return this.sourceCache[t]=l,l}assignTexture(t,e,r,n){const i=this;return this.getDependency("texture",r.index).then(function(s){if(!s)return null;if(r.texCoord!==void 0&&r.texCoord>0&&(s=s.clone(),s.channel=r.texCoord),i.extensions[A.KHR_TEXTURE_TRANSFORM]){const a=r.extensions!==void 0?r.extensions[A.KHR_TEXTURE_TRANSFORM]:void 0;if(a){const o=i.associations.get(s);s=i.extensions[A.KHR_TEXTURE_TRANSFORM].extendTexture(s,a),i.associations.set(s,o)}}return n!==void 0&&(s.colorSpace=n),t[e]=s,s})}assignFinalMaterial(t){const e=t.geometry;let r=t.material;const n=e.attributes.tangent===void 0,i=e.attributes.color!==void 0,s=e.attributes.normal===void 0;if(t.isPoints){const a="PointsMaterial:"+r.uuid;let o=this.cache.get(a);o||(o=new He,K.prototype.copy.call(o,r),o.color.copy(r.color),o.map=r.map,o.sizeAttenuation=!1,this.cache.add(a,o)),r=o}else if(t.isLine){const a="LineBasicMaterial:"+r.uuid;let o=this.cache.get(a);o||(o=new Ge,K.prototype.copy.call(o,r),o.color.copy(r.color),o.map=r.map,this.cache.add(a,o)),r=o}if(n||i||s){let a="ClonedMaterial:"+r.uuid+":";n&&(a+="derivative-tangents:"),i&&(a+="vertex-colors:"),s&&(a+="flat-shading:");let o=this.cache.get(a);o||(o=r.clone(),i&&(o.vertexColors=!0),s&&(o.flatShading=!0),n&&(o.normalScale&&(o.normalScale.y*=-1),o.clearcoatNormalScale&&(o.clearcoatNormalScale.y*=-1)),this.cache.add(a,o),this.associations.set(o,this.associations.get(r))),r=o}t.material=r}getMaterialType(){return ge}loadMaterial(t){const e=this,r=this.json,n=this.extensions,i=r.materials[t];let s;const a={},o=i.extensions||{},c=[];if(o[A.KHR_MATERIALS_UNLIT]){const u=n[A.KHR_MATERIALS_UNLIT];s=u.getMaterialType(),c.push(u.extendParams(a,i,e))}else{const u=i.pbrMetallicRoughness||{};if(a.color=new O(1,1,1),a.opacity=1,Array.isArray(u.baseColorFactor)){const d=u.baseColorFactor;a.color.setRGB(d[0],d[1],d[2],M),a.opacity=d[3]}u.baseColorTexture!==void 0&&c.push(e.assignTexture(a,"map",u.baseColorTexture,G)),a.metalness=u.metallicFactor!==void 0?u.metallicFactor:1,a.roughness=u.roughnessFactor!==void 0?u.roughnessFactor:1,u.metallicRoughnessTexture!==void 0&&(c.push(e.assignTexture(a,"metalnessMap",u.metallicRoughnessTexture)),c.push(e.assignTexture(a,"roughnessMap",u.metallicRoughnessTexture))),s=this._invokeOne(function(d){return d.getMaterialType&&d.getMaterialType(t)}),c.push(Promise.all(this._invokeAll(function(d){return d.extendMaterialParams&&d.extendMaterialParams(t,a)})))}i.doubleSided===!0&&(a.side=Ue);const l=i.alphaMode||z.OPAQUE;if(l===z.BLEND?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,l===z.MASK&&(a.alphaTest=i.alphaCutoff!==void 0?i.alphaCutoff:.5)),i.normalTexture!==void 0&&s!==F&&(c.push(e.assignTexture(a,"normalMap",i.normalTexture)),a.normalScale=new fe(1,1),i.normalTexture.scale!==void 0)){const u=i.normalTexture.scale;a.normalScale.set(u,u)}if(i.occlusionTexture!==void 0&&s!==F&&(c.push(e.assignTexture(a,"aoMap",i.occlusionTexture)),i.occlusionTexture.strength!==void 0&&(a.aoMapIntensity=i.occlusionTexture.strength)),i.emissiveFactor!==void 0&&s!==F){const u=i.emissiveFactor;a.emissive=new O().setRGB(u[0],u[1],u[2],M)}return i.emissiveTexture!==void 0&&s!==F&&c.push(e.assignTexture(a,"emissiveMap",i.emissiveTexture,G)),Promise.all(c).then(function(){const u=new s(a);return i.name&&(u.name=i.name),b(u,i),e.associations.set(u,{materials:t}),i.extensions&&C(n,u,i),u})}createUniqueName(t){const e=Be.sanitizeNodeName(t||"");return e in this.nodeNamesUsed?e+"_"+ ++this.nodeNamesUsed[e]:(this.nodeNamesUsed[e]=0,e)}loadGeometries(t){const e=this,r=this.extensions,n=this.primitiveCache;function i(a){return r[A.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(a,e).then(function(o){return ue(o,a,e)})}const s=[];for(let a=0,o=t.length;a<o;a++){const c=t[a],l=Ft(c),u=n[l];if(u)s.push(u.promise);else{let d;c.extensions&&c.extensions[A.KHR_DRACO_MESH_COMPRESSION]?d=i(c):d=ue(new je,c,e),n[l]={primitive:c,promise:d},s.push(d)}}return Promise.all(s)}loadMesh(t){const e=this,r=this.json,n=this.extensions,i=r.meshes[t],s=i.primitives,a=[];for(let o=0,c=s.length;o<c;o++){const l=s[o].material===void 0?Ot(this.cache):this.getDependency("material",s[o].material);a.push(l)}return a.push(e.loadGeometries(s)),Promise.all(a).then(function(o){const c=o.slice(0,o.length-1),l=o[o.length-1],u=[];for(let f=0,p=l.length;f<p;f++){const T=l[f],m=s[f];let g;const E=c[f];if(m.mode===L.TRIANGLES||m.mode===L.TRIANGLE_STRIP||m.mode===L.TRIANGLE_FAN||m.mode===void 0)g=i.isSkinnedMesh===!0?new Ke(T,E):new Te(T,E),g.isSkinnedMesh===!0&&g.normalizeSkinWeights(),m.mode===L.TRIANGLE_STRIP?g.geometry=re(g.geometry,he):m.mode===L.TRIANGLE_FAN&&(g.geometry=re(g.geometry,Y));else if(m.mode===L.LINES)g=new Ve(T,E);else if(m.mode===L.LINE_STRIP)g=new Xe(T,E);else if(m.mode===L.LINE_LOOP)g=new ze(T,E);else if(m.mode===L.POINTS)g=new qe(T,E);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+m.mode);Object.keys(g.geometry.morphAttributes).length>0&&Pt(g,i),g.name=e.createUniqueName(i.name||"mesh_"+t),b(g,i),m.extensions&&C(n,g,m),e.assignFinalMaterial(g),u.push(g)}for(let f=0,p=u.length;f<p;f++)e.associations.set(u[f],{meshes:t,primitives:f});if(u.length===1)return i.extensions&&C(n,u[0],i),u[0];const d=new V;i.extensions&&C(n,d,i),e.associations.set(d,{meshes:t});for(let f=0,p=u.length;f<p;f++)d.add(u[f]);return d})}loadCamera(t){let e;const r=this.json.cameras[t],n=r[r.type];if(!n){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return r.type==="perspective"?e=new Ye(We.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):r.type==="orthographic"&&(e=new Qe(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),r.name&&(e.name=this.createUniqueName(r.name)),b(e,r),Promise.resolve(e)}loadSkin(t){const e=this.json.skins[t],r=[];for(let n=0,i=e.joints.length;n<i;n++)r.push(this._loadNodeShallow(e.joints[n]));return e.inverseBindMatrices!==void 0?r.push(this.getDependency("accessor",e.inverseBindMatrices)):r.push(null),Promise.all(r).then(function(n){const i=n.pop(),s=n,a=[],o=[];for(let c=0,l=s.length;c<l;c++){const u=s[c];if(u){a.push(u);const d=new U;i!==null&&d.fromArray(i.array,c*16),o.push(d)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',e.joints[c])}return new $e(a,o)})}loadAnimation(t){const e=this.json,r=this,n=e.animations[t],i=n.name?n.name:"animation_"+t,s=[],a=[],o=[],c=[],l=[];for(let u=0,d=n.channels.length;u<d;u++){const f=n.channels[u],p=n.samplers[f.sampler],T=f.target,m=T.node,g=n.parameters!==void 0?n.parameters[p.input]:p.input,E=n.parameters!==void 0?n.parameters[p.output]:p.output;T.node!==void 0&&(s.push(this.getDependency("node",m)),a.push(this.getDependency("accessor",g)),o.push(this.getDependency("accessor",E)),c.push(p),l.push(T))}return Promise.all([Promise.all(s),Promise.all(a),Promise.all(o),Promise.all(c),Promise.all(l)]).then(function(u){const d=u[0],f=u[1],p=u[2],T=u[3],m=u[4],g=[];for(let E=0,y=d.length;E<y;E++){const x=d[E],v=f[E],N=p[E],w=T[E],k=m[E];if(x===void 0)continue;x.updateMatrix&&x.updateMatrix();const S=r._createAnimationTracks(x,v,N,w,k);if(S)for(let B=0;B<S.length;B++)g.push(S[B])}return new Ze(i,void 0,g)})}createNodeMesh(t){const e=this.json,r=this,n=e.nodes[t];return n.mesh===void 0?null:r.getDependency("mesh",n.mesh).then(function(i){const s=r._getNodeRef(r.meshCache,n.mesh,i);return n.weights!==void 0&&s.traverse(function(a){if(a.isMesh)for(let o=0,c=n.weights.length;o<c;o++)a.morphTargetInfluences[o]=n.weights[o]}),s})}loadNode(t){const e=this.json,r=this,n=e.nodes[t],i=r._loadNodeShallow(t),s=[],a=n.children||[];for(let c=0,l=a.length;c<l;c++)s.push(r.getDependency("node",a[c]));const o=n.skin===void 0?Promise.resolve(null):r.getDependency("skin",n.skin);return Promise.all([i,Promise.all(s),o]).then(function(c){const l=c[0],u=c[1],d=c[2];d!==null&&l.traverse(function(f){f.isSkinnedMesh&&f.bind(d,kt)});for(let f=0,p=u.length;f<p;f++)l.add(u[f]);return l})}_loadNodeShallow(t){const e=this.json,r=this.extensions,n=this;if(this.nodeCache[t]!==void 0)return this.nodeCache[t];const i=e.nodes[t],s=i.name?n.createUniqueName(i.name):"",a=[],o=n._invokeOne(function(c){return c.createNodeMesh&&c.createNodeMesh(t)});return o&&a.push(o),i.camera!==void 0&&a.push(n.getDependency("camera",i.camera).then(function(c){return n._getNodeRef(n.cameraCache,i.camera,c)})),n._invokeAll(function(c){return c.createNodeAttachment&&c.createNodeAttachment(t)}).forEach(function(c){a.push(c)}),this.nodeCache[t]=Promise.all(a).then(function(c){let l;if(i.isBone===!0?l=new Je:c.length>1?l=new V:c.length===1?l=c[0]:l=new J,l!==c[0])for(let u=0,d=c.length;u<d;u++)l.add(c[u]);if(i.name&&(l.userData.name=i.name,l.name=s),b(l,i),i.extensions&&C(r,l,i),i.matrix!==void 0){const u=new U;u.fromArray(i.matrix),l.applyMatrix4(u)}else i.translation!==void 0&&l.position.fromArray(i.translation),i.rotation!==void 0&&l.quaternion.fromArray(i.rotation),i.scale!==void 0&&l.scale.fromArray(i.scale);return n.associations.has(l)||n.associations.set(l,{}),n.associations.get(l).nodes=t,l}),this.nodeCache[t]}loadScene(t){const e=this.extensions,r=this.json.scenes[t],n=this,i=new V;r.name&&(i.name=n.createUniqueName(r.name)),b(i,r),r.extensions&&C(e,i,r);const s=r.nodes||[],a=[];for(let o=0,c=s.length;o<c;o++)a.push(n.getDependency("node",s[o]));return Promise.all(a).then(function(o){for(let l=0,u=o.length;l<u;l++)i.add(o[l]);const c=l=>{const u=new Map;for(const[d,f]of n.associations)(d instanceof K||d instanceof ee)&&u.set(d,f);return l.traverse(d=>{const f=n.associations.get(d);f!=null&&u.set(d,f)}),u};return n.associations=c(i),i})}_createAnimationTracks(t,e,r,n,i){const s=[],a=t.name?t.name:t.uuid,o=[];_[i.path]===_.weights?t.traverse(function(d){d.morphTargetInfluences&&o.push(d.name?d.name:d.uuid)}):o.push(a);let c;switch(_[i.path]){case _.weights:c=ne;break;case _.rotation:c=se;break;case _.position:case _.scale:c=te;break;default:switch(r.itemSize){case 1:c=ne;break;case 2:case 3:default:c=te;break}break}const l=n.interpolation!==void 0?Ct[n.interpolation]:xe,u=this._getArrayFromAccessor(r);for(let d=0,f=o.length;d<f;d++){const p=new c(o[d]+"."+_[i.path],e.array,u,l);n.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(p),s.push(p)}return s}_getArrayFromAccessor(t){let e=t.array;if(t.normalized){const r=Z(e.constructor),n=new Float32Array(e.length);for(let i=0,s=e.length;i<s;i++)n[i]=e[i]*r;e=n}return e}_createCubicSplineTrackInterpolant(t){t.createInterpolant=function(r){const n=this instanceof se?It:Re;return new n(this.times,this.values,this.getValueSize()/3,r)},t.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function Gt(h,t,e){const r=t.attributes,n=new it;if(r.POSITION!==void 0){const a=e.json.accessors[r.POSITION],o=a.min,c=a.max;if(o!==void 0&&c!==void 0){if(n.set(new P(o[0],o[1],o[2]),new P(c[0],c[1],c[2])),a.normalized){const l=Z(D[a.componentType]);n.min.multiplyScalar(l),n.max.multiplyScalar(l)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const i=t.targets;if(i!==void 0){const a=new P,o=new P;for(let c=0,l=i.length;c<l;c++){const u=i[c];if(u.POSITION!==void 0){const d=e.json.accessors[u.POSITION],f=d.min,p=d.max;if(f!==void 0&&p!==void 0){if(o.setX(Math.max(Math.abs(f[0]),Math.abs(p[0]))),o.setY(Math.max(Math.abs(f[1]),Math.abs(p[1]))),o.setZ(Math.max(Math.abs(f[2]),Math.abs(p[2]))),d.normalized){const T=Z(D[d.componentType]);o.multiplyScalar(T)}a.max(o)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}n.expandByVector(a)}h.boundingBox=n;const s=new rt;n.getCenter(s.center),s.radius=n.min.distanceTo(n.max)/2,h.boundingSphere=s}function ue(h,t,e){const r=t.attributes,n=[];function i(s,a){return e.getDependency("accessor",s).then(function(o){h.setAttribute(a,o)})}for(const s in r){const a=$[s]||s.toLowerCase();a in h.attributes||n.push(i(r[s],a))}if(t.indices!==void 0&&!h.index){const s=e.getDependency("accessor",t.indices).then(function(a){h.setIndex(a)});n.push(s)}return ie.workingColorSpace!==M&&"COLOR_0"in r&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${ie.workingColorSpace}" not supported.`),b(h,t),Gt(h,t,e),Promise.all(n).then(function(){return t.targets!==void 0?vt(h,t.targets,e):h})}const R={ComponentState:Object.freeze({DEFAULT:"default",TOUCHED:"touched",PRESSED:"pressed"}),ComponentProperty:Object.freeze({BUTTON:"button",X_AXIS:"xAxis",Y_AXIS:"yAxis",STATE:"state"}),ComponentType:Object.freeze({TRIGGER:"trigger",SQUEEZE:"squeeze",TOUCHPAD:"touchpad",THUMBSTICK:"thumbstick",BUTTON:"button"}),ButtonTouchThreshold:.05,AxisTouchThreshold:.1,VisualResponseProperty:Object.freeze({TRANSFORM:"transform",VISIBILITY:"visibility"})};async function ye(h){const t=await fetch(h);if(t.ok)return t.json();throw new Error(t.statusText)}async function Ut(h){if(!h)throw new Error("No basePath supplied");return await ye(`${h}/profilesList.json`)}async function Bt(h,t,e=null,r=!0){if(!h)throw new Error("No xrInputSource supplied");if(!t)throw new Error("No basePath supplied");const n=await Ut(t);let i;if(h.profiles.some(o=>{const c=n[o];return c&&(i={profileId:o,profilePath:`${t}/${c.path}`,deprecated:!!c.deprecated}),!!i}),!i){if(!e)throw new Error("No matching profile name found");const o=n[e];if(!o)throw new Error(`No matching profile name found and default profile "${e}" missing.`);i={profileId:e,profilePath:`${t}/${o.path}`,deprecated:!!o.deprecated}}const s=await ye(i.profilePath);let a;if(r){let o;if(h.handedness==="any"?o=s.layouts[Object.keys(s.layouts)[0]]:o=s.layouts[h.handedness],!o)throw new Error(`No matching handedness, ${h.handedness}, in profile ${i.profileId}`);o.assetPath&&(a=i.profilePath.replace("profile.json",o.assetPath))}return{profile:s,assetPath:a}}const jt={xAxis:0,yAxis:0,button:0,state:R.ComponentState.DEFAULT};function Kt(h=0,t=0){let e=h,r=t;if(Math.sqrt(h*h+t*t)>1){const s=Math.atan2(t,h);e=Math.cos(s),r=Math.sin(s)}return{normalizedXAxis:e*.5+.5,normalizedYAxis:r*.5+.5}}class Vt{constructor(t){this.componentProperty=t.componentProperty,this.states=t.states,this.valueNodeName=t.valueNodeName,this.valueNodeProperty=t.valueNodeProperty,this.valueNodeProperty===R.VisualResponseProperty.TRANSFORM&&(this.minNodeName=t.minNodeName,this.maxNodeName=t.maxNodeName),this.value=0,this.updateFromComponent(jt)}updateFromComponent({xAxis:t,yAxis:e,button:r,state:n}){const{normalizedXAxis:i,normalizedYAxis:s}=Kt(t,e);switch(this.componentProperty){case R.ComponentProperty.X_AXIS:this.value=this.states.includes(n)?i:.5;break;case R.ComponentProperty.Y_AXIS:this.value=this.states.includes(n)?s:.5;break;case R.ComponentProperty.BUTTON:this.value=this.states.includes(n)?r:0;break;case R.ComponentProperty.STATE:this.valueNodeProperty===R.VisualResponseProperty.VISIBILITY?this.value=this.states.includes(n):this.value=this.states.includes(n)?1:0;break;default:throw new Error(`Unexpected visualResponse componentProperty ${this.componentProperty}`)}}}class Xt{constructor(t,e){if(!t||!e||!e.visualResponses||!e.gamepadIndices||Object.keys(e.gamepadIndices).length===0)throw new Error("Invalid arguments supplied");this.id=t,this.type=e.type,this.rootNodeName=e.rootNodeName,this.touchPointNodeName=e.touchPointNodeName,this.visualResponses={},Object.keys(e.visualResponses).forEach(r=>{const n=new Vt(e.visualResponses[r]);this.visualResponses[r]=n}),this.gamepadIndices=Object.assign({},e.gamepadIndices),this.values={state:R.ComponentState.DEFAULT,button:this.gamepadIndices.button!==void 0?0:void 0,xAxis:this.gamepadIndices.xAxis!==void 0?0:void 0,yAxis:this.gamepadIndices.yAxis!==void 0?0:void 0}}get data(){return{id:this.id,...this.values}}updateFromGamepad(t){if(this.values.state=R.ComponentState.DEFAULT,this.gamepadIndices.button!==void 0&&t.buttons.length>this.gamepadIndices.button){const e=t.buttons[this.gamepadIndices.button];this.values.button=e.value,this.values.button=this.values.button<0?0:this.values.button,this.values.button=this.values.button>1?1:this.values.button,e.pressed||this.values.button===1?this.values.state=R.ComponentState.PRESSED:(e.touched||this.values.button>R.ButtonTouchThreshold)&&(this.values.state=R.ComponentState.TOUCHED)}this.gamepadIndices.xAxis!==void 0&&t.axes.length>this.gamepadIndices.xAxis&&(this.values.xAxis=t.axes[this.gamepadIndices.xAxis],this.values.xAxis=this.values.xAxis<-1?-1:this.values.xAxis,this.values.xAxis=this.values.xAxis>1?1:this.values.xAxis,this.values.state===R.ComponentState.DEFAULT&&Math.abs(this.values.xAxis)>R.AxisTouchThreshold&&(this.values.state=R.ComponentState.TOUCHED)),this.gamepadIndices.yAxis!==void 0&&t.axes.length>this.gamepadIndices.yAxis&&(this.values.yAxis=t.axes[this.gamepadIndices.yAxis],this.values.yAxis=this.values.yAxis<-1?-1:this.values.yAxis,this.values.yAxis=this.values.yAxis>1?1:this.values.yAxis,this.values.state===R.ComponentState.DEFAULT&&Math.abs(this.values.yAxis)>R.AxisTouchThreshold&&(this.values.state=R.ComponentState.TOUCHED)),Object.values(this.visualResponses).forEach(e=>{e.updateFromComponent(this.values)})}}class zt{constructor(t,e,r){if(!t)throw new Error("No xrInputSource supplied");if(!e)throw new Error("No profile supplied");this.xrInputSource=t,this.assetUrl=r,this.id=e.profileId,this.layoutDescription=e.layouts[t.handedness],this.components={},Object.keys(this.layoutDescription.components).forEach(n=>{const i=this.layoutDescription.components[n];this.components[n]=new Xt(n,i)}),this.updateFromGamepad()}get gripSpace(){return this.xrInputSource.gripSpace}get targetRaySpace(){return this.xrInputSource.targetRaySpace}get data(){const t=[];return Object.values(this.components).forEach(e=>{t.push(e.data)}),t}updateFromGamepad(){Object.values(this.components).forEach(t=>{t.updateFromGamepad(this.xrInputSource.gamepad)})}}const qt="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles",Yt="generic-trigger";class Wt extends J{constructor(){super(),this.motionController=null,this.envMap=null}setEnvironmentMap(t){return this.envMap==t?this:(this.envMap=t,this.traverse(e=>{e.isMesh&&(e.material.envMap=this.envMap,e.material.needsUpdate=!0)}),this)}updateMatrixWorld(t){super.updateMatrixWorld(t),this.motionController&&(this.motionController.updateFromGamepad(),Object.values(this.motionController.components).forEach(e=>{Object.values(e.visualResponses).forEach(r=>{const{valueNode:n,minNode:i,maxNode:s,value:a,valueNodeProperty:o}=r;n&&(o===R.VisualResponseProperty.VISIBILITY?n.visible=a:o===R.VisualResponseProperty.TRANSFORM&&(n.quaternion.slerpQuaternions(i.quaternion,s.quaternion,a),n.position.lerpVectors(i.position,s.position,a)))})}))}}function Qt(h,t){Object.values(h.components).forEach(e=>{const{type:r,touchPointNodeName:n,visualResponses:i}=e;if(r===R.ComponentType.TOUCHPAD)if(e.touchPointNode=t.getObjectByName(n),e.touchPointNode){const s=new ot(.001),a=new F({color:255}),o=new Te(s,a);e.touchPointNode.add(o)}else console.warn(`Could not find touch dot, ${e.touchPointNodeName}, in touchpad component ${e.id}`);Object.values(i).forEach(s=>{const{valueNodeName:a,minNodeName:o,maxNodeName:c,valueNodeProperty:l}=s;if(l===R.VisualResponseProperty.TRANSFORM){if(s.minNode=t.getObjectByName(o),s.maxNode=t.getObjectByName(c),!s.minNode){console.warn(`Could not find ${o} in the model`);return}if(!s.maxNode){console.warn(`Could not find ${c} in the model`);return}}s.valueNode=t.getObjectByName(a),s.valueNode||console.warn(`Could not find ${a} in the model`)})})}function le(h,t){Qt(h.motionController,t),h.envMap&&t.traverse(e=>{e.isMesh&&(e.material.envMap=h.envMap,e.material.needsUpdate=!0)}),h.add(t)}class Zt{constructor(t=null){this.gltfLoader=t,this.path=qt,this._assetCache={},this.gltfLoader||(this.gltfLoader=new at)}createControllerModel(t){const e=new Wt;let r=null;return t.addEventListener("connected",n=>{const i=n.data;i.targetRayMode!=="tracked-pointer"||!i.gamepad||Bt(i,this.path,Yt).then(({profile:s,assetPath:a})=>{e.motionController=new zt(i,s,a);const o=this._assetCache[e.motionController.assetUrl];if(o)r=o.scene.clone(),le(e,r);else{if(!this.gltfLoader)throw new Error("GLTFLoader not set.");this.gltfLoader.setPath(""),this.gltfLoader.load(e.motionController.assetUrl,c=>{this._assetCache[e.motionController.assetUrl]=c,r=c.scene.clone(),le(e,r)},null,()=>{throw new Error(`Asset ${e.motionController.assetUrl} missing or malformed.`)})}}).catch(s=>{console.warn(s)})}),t.addEventListener("disconnected",()=>{e.motionController=null,e.remove(r),r=null}),e}}export{Zt as XRControllerModelFactory};
